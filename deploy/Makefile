MODULE ?= $(m)
IMAGE ?= vshefer/receipt-java/$(MODULE)
CONTAINER ?= receipt-java-$(MODULE)

ansible-test: ## -
	ansible-playbook -i hosts.yml test.yml -K

build: require-module remove-image ## Build the docker image
	docker build .. \
        --rm \
		--tag $(IMAGE) \
		--file ./Dockerfile \
		--build-arg \
		    MODULE=$(MODULE)

cleanup: ## Removes all intermediate and <None> images
	@docker rmi $(shell docker images --filter "dangling=true" -q --no-trunc) \
		2> /dev/null || echo "No dangling images to remove"

publish: ## Push image to DockerHub
	docker push $(IMAGE)

remove-image: require-module remove-container ## Removes already built docker images
	@docker rmi $(IMAGE) \
		2> /dev/null || echo "Image not found"

remove-container: require-module stop ## Removes already built docker images
	@docker rm $(CONTAINER) \
		2> /dev/null || echo "No such container"

run: require-module ## Run the container
	docker-compose up -d $(MODULE)

stop: require-module ## Stop currently running application
	@docker stop $(CONTAINER) \
		2> /dev/null || echo "Application $(MODULE) not running"

logs: require-module ## Show logs
	docker logs -f $(CONTAINER)\
		2> /dev/null || echo "Application $(MODULE) not exists"

deploy: require-module build cleanup run logs ## Full (re-)deploy of application with cleanup

require-module: ## Fail if MODULE variable is undefined
ifndef MODULE
	$(error MODULE is undefined)
endif

help: ## Autogenerated help reference for make
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'
.DEFAULT_GOAL := help
.PHONY: *
